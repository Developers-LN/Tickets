@model Tickets.Models.Invoice
@{
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
    ViewBag.Title = "";

    var context = new Tickets.Models.TicketsEntities();
    var config = context.SystemConfigs.FirstOrDefault();
    string adminName = config != null ? config.LoteryAdmin : "";
    string adminCargo = config != null ? config.Cargo : "";
    System.Threading.Thread.CurrentThread.CurrentCulture = new System.Globalization.CultureInfo("es-DO");

    var xpiredDate = Model.InvoiceDate.AddDays(Model.InvoiceExpredDay.Value);

    var InvoiceDiscount2 = 0.0m;
}
<style>
    .col-lg-12{
        width: 100%;
        float: left;
    }
    .col-lg-4 {
        width: 33.333%;
         float: left;
    }
    .col-lg-6{
        width: 50%;
        float: left;
    } 
    
    .text-center {
        text-align: center;
    }
    .text-right {
        text-align:right;
    }
    .text-left {
        text-align:left;
    }
    .no-padder {
        padding-left: 0px;
        padding-right: 0px;
    }
</style>

<div class="col-lg-12">
    <div class="col-lg-12 no-padder text-center">
        <div class="col-lg-12 no-padder text-center" style="margin-top: 50px;">
            <img src="~/Images/logo.png"/>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>MINISTERIO DE HACIENDA</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>ADMINISTRACION DE LA LOTERIA NACIONAL</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>DETALLE DE FACTURAS SORTEO NO.@Model.Raffle.Id DE FECHA @Model.Raffle.DateSolteo.ToShortDateString()</b>
        </div>
        <div class="col-lg-6 no-padder">
            <div class="col-lg-12 no-padder text-left">
                <b>Cliente: </b> #@Model.Client.Name @Model.Client.TicketAllocations.Select(s => s.Agente).FirstOrDefault()
            </div>
            <div class="col-lg-12 no-padder text-left">
                <b>Cajero: </b> #@Model.CreateUser
            </div>
            <div class="col-lg-12 no-padder text-left">
                <b>Fecha de Expiración: </b> @xpiredDate.ToShortDateString()
            </div>
        </div>
        <div class="col-lg-6 no-padder text-right">
            <div class="col-lg-12 no-padder text-right">
                <b>Factura: </b> #@Model.Id
            </div>
            <div class="col-lg-12 no-padder text-right">
                <b>Fecha: </b> @DateTime.Now.ToShortDateString()
            </div>
            <div class="col-lg-12 no-padder text-right">
                <b>Hora: </b> @DateTime.Now.ToShortTimeString()
            </div>
        </div>
    </div>
    <div class="col-lg-12 no-padder">
        <table class="table">
            <thead>
                <tr>
                    <th class="text-center">ASIGNACION</th>
                    <th class="text-center">CANTIDAD DE BILLETES</th>
                    <th class="text-center">CANTIDAD DE FRACCIONES</th>
                    <th class="text-right">PRECIO POR FRACCION</th>
                    <th class="text-right">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int subTotalNumber = 0, subTotalFraction = 0, subtotalBilletes = 0;
                    decimal subTotalValue = 0.0m, totalClientDiscount=0.00m, InvoiceDiscount = 0.0m;
                    var priceFraction = Model.Raffle.Prospect.Prospect_Price.FirstOrDefault(p => p.PriceId == Model.Client.PriceId).FactionPrice;
                    var allocations = Model.InvoiceTickets.GroupBy(a => a.TicketAllocationNumber.TicketAllocationId).Select( a=> new{
                        AllocationId = a.FirstOrDefault().TicketAllocationNumber.TicketAllocationId,
                        Quantity = a.FirstOrDefault().Quantity * a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.TicketAllocationNumbers.Count(),
                        Numbers = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.TicketAllocationNumbers,
                        FractionFrom = a.FirstOrDefault().TicketAllocationNumber.FractionFrom,
                        FractionTo = a.FirstOrDefault().TicketAllocationNumber.FractionTo,
                        //ClientDiscount = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.Client.Discount,
                        ClientDiscount = @Model.Discount, //a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.Invoice.Discount,
						//InvoiceDiscount = ClientDiscount,
                        TypeId = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.Type
                    });
                }
                    @foreach (var number in allocations)
                    {
                        subTotalNumber += 1;
                        subTotalFraction += number.Quantity;
                        var subTotal = number.Quantity * priceFraction;
                        subtotalBilletes += number.Numbers.Count; 
                        <tr>
                            <td class="text-center">@number.AllocationId</td>
                            <td class="text-center">@number.Numbers.Count </td>
                            <td class="text-center">@number.Quantity</td>
                            <td class="text-right">@priceFraction.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                            <td class="text-right">@subTotal.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                        </tr>
                        subTotalValue += subTotal;
                        totalClientDiscount += (subTotal * number.ClientDiscount) / 100;
						InvoiceDiscount2 = totalClientDiscount;
                    }
                </tbody>
                <tfoot>
                    <tr style="border-top: 4px double black">
                        <td class="text-center">@subTotalNumber</td>
                        <td class="text-center">@subtotalBilletes</td>
                        <td class="text-center">@subTotalFraction</td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Sub Total: @subTotalValue.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                    </tr>
                    <tr >
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Descuento: @(totalClientDiscount.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                    </tr>
                    <tr>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Total: @((subTotalValue - totalClientDiscount).ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                    </tr>
                </tfoot>
        </table>
    </div>
    
    <div class="col-lg-12 no-padder text-center">
        <div class="col-lg-6 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Firma del Cliente
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Firma Encargada de Facturacion
        </div>
    </div>
    <div class="col-lg-12 no-padder text-center">
        <b>@adminName</b>
    </div>
    <div class="col-lg-12 no-padder text-center">
        <span>@adminCargo</span>
    </div>
</div>

<br>
<br>

<div class="col-lg-12">
    <div class="col-lg-12 no-padder text-center">
        <div class="col-lg-12 no-padder text-center" style="margin-top: 50px;">
            <img src="~/Images/logo.png"/>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>MINISTERIO DE HACIENDA</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>ADMINISTRACION DE LA LOTERIA NACIONAL</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>DETALLE DE FACTURAS SORTEO NO.@Model.Raffle.Id DE FECHA @Model.Raffle.DateSolteo.ToShortDateString()</b>
        </div>
        <div class="col-lg-6 no-padder">
            <div class="col-lg-12 no-padder text-left">
                <b>Cliente: </b> #@Model.Client.Name
            </div>
            <div class="col-lg-12 no-padder text-left">
                <b>Cajero: </b> #@Model.CreateUser
            </div>
            <div class="col-lg-12 no-padder text-left">
                <b>Fecha de Expiración: </b> @xpiredDate.ToShortDateString()
            </div>
        </div>
        <div class="col-lg-6 no-padder text-right">
            <div class="col-lg-12 no-padder text-right">
                <b>Factura: </b> #@Model.Id
            </div>
            <div class="col-lg-12 no-padder text-right">
                <b>Fecha: </b> @DateTime.Now.ToShortDateString()
            </div>
            <div class="col-lg-12 no-padder text-right">
                <b>Hora: </b> @DateTime.Now.ToShortTimeString()
            </div>
        </div>
    </div>
    <div class="col-lg-12 no-padder">
        <table class="table">
            <thead>
                <tr>
                    <th class="text-center">ASIGNACION</th>
                    <th class="text-center">CANTIDAD DE BILLETES</th>
                    <th class="text-center">CANTIDAD DE FRACCIONES</th>
                    <th class="text-right">PRECIO POR FRACCION</th>
                    <th class="text-right">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                @{
                    subTotalNumber = 0; subTotalFraction = 0; subtotalBilletes = 0;
                    subTotalValue = 0.0m; totalClientDiscount=0.00m;
                    priceFraction = Model.Raffle.Prospect.Prospect_Price.FirstOrDefault(p => p.PriceId == Model.Client.PriceId).FactionPrice;
                    allocations = Model.InvoiceTickets.GroupBy(a => a.TicketAllocationNumber.TicketAllocationId).Select( a=> new{
                        AllocationId = a.FirstOrDefault().TicketAllocationNumber.TicketAllocationId,
                        Quantity = a.FirstOrDefault().Quantity * a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.TicketAllocationNumbers.Count(),
                        Numbers = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.TicketAllocationNumbers,
                        FractionFrom = a.FirstOrDefault().TicketAllocationNumber.FractionFrom,
                        FractionTo = a.FirstOrDefault().TicketAllocationNumber.FractionTo,
                        ClientDiscount = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.Client.Discount,
                        TypeId = a.FirstOrDefault().TicketAllocationNumber.TicketAllocation.Type
                    });
                }
                    @foreach (var number in allocations)
                    {
                        subTotalNumber += 1;
                        subTotalFraction += number.Quantity;
                        var subTotal = number.Quantity * priceFraction;
                        subtotalBilletes += number.Numbers.Count; 
                        <tr>
                            <td class="text-center">@number.AllocationId</td>
                            <td class="text-center">@number.Numbers.Count </td>
                            <td class="text-center">@number.Quantity</td>
                            <td class="text-right">@priceFraction.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                            <td class="text-right">@subTotal.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                        </tr>
                        subTotalValue += subTotal;
                        totalClientDiscount = InvoiceDiscount2; //+= (subTotal * number.ClientDiscount) / 100;
                    }
                </tbody>
                <tfoot>
                    <tr style="border-top: 4px double black">
                        <td class="text-center">@subTotalNumber</td>
                        <td class="text-center">@subtotalBilletes</td>
                        <td class="text-center">@subTotalFraction</td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Sub Total: @subTotalValue.ToString("c",  new System.Globalization.CultureInfo("es-DO"))</td>
                    </tr>
                    <tr >
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Descuento: @(totalClientDiscount.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                    </tr>
                    <tr>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                        <td class="text-right"></td>
                        <td class="text-right" style="font-weight:bold;">Total: @((subTotalValue - totalClientDiscount).ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                    </tr>
                </tfoot>
        </table>
    </div>
    
    <div class="col-lg-12 no-padder text-center">
        <div class="col-lg-6 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Firma del Cliente
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Firma Encargada de Facturacion
        </div>
    </div>
    <div class="col-lg-12 no-padder text-center">
        <b>@adminName</b>
    </div>
    <div class="col-lg-12 no-padder text-center">
        <span>@adminCargo</span>
    </div>
</div>


