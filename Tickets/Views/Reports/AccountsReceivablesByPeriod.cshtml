@model IEnumerable<Tickets.Models.ModelsProcedures.ModelProcedure_SalesAndPendingPayments>

@{
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
    if (Model.AsEnumerable().GroupBy(r => r.IdRaffle).Select(s => s.Key).ToList().Count() == 1)
    {
        ViewBag.Title = "REPORTE DE COBROS REALIZADOS EN EL PERIODO " + ViewBag.startDate + " Y " + ViewBag.endDate + " DEL SORTEO " + @Model.FirstOrDefault().IdRaffle;
    }
    else
    {
        ViewBag.Title = "REPORTE DE COBROS REALIZADOS EN EL PERIODO " + ViewBag.startDate + " y " + ViewBag.endDate;
    }

    var context = new Tickets.Models.TicketsEntities();
    var config = context.SystemConfigs.FirstOrDefault();
    string adminName = config != null ? config.CreditosCobros : "";
    string adminCargo = config != null ? config.CreditosCobrosCargo : "";
    System.Threading.Thread.CurrentThread.CurrentCulture = new System.Globalization.CultureInfo("es-DO");
}

<style>
    .col-lg-12 {
        width: 100%;
        float: left;
    }

    .col-lg-4 {
        width: 33.333%;
        float: left;
    }

    .col-lg-6 {
        width: 50%;
        float: left;
    }

    .text-center {
        text-align: center;
    }

    .text-right {
        text-align: right;
    }

    .text-left {
        text-align: left;
    }

    .no-padder {
        padding-left: 5px;
        padding-right: 5px;
    }
</style>

<div class="col-lg-12">
    <div class="col-lg-12 no-padder text-center">
        <div class="col-lg-12 no-padder text-center" style="margin-top: 50px;">
            <img style="height:65px; width:auto; margin-bottom:5px;" src="~/Images/logo.png" />
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>MINISTERIO DE HACIENDA</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>ADMINISTRACION DE LA LOTERIA NACIONAL</b>
        </div>
        <div class="col-lg-12 no-padder text-center">
            <b>REPORTE DE COBROS REALIZADOS EN EL PERIODO @ViewBag.startDate Y @ViewBag.endDate</b>
            @if (Model.AsEnumerable().GroupBy(r => r.IdRaffle).Select(s => s.Key).ToList().Count() == 1)
            {
                <b>DEL SORTEO NO. @Model.FirstOrDefault().IdRaffle</b>
            }
        </div>
    </div>
    <div class="col-lg-12 no-padder">
        <div class="col-lg-6 no-padder text-left">
        </div>
        <div class="col-lg-6 no-padder text-right">
            <b>Fecha: </b> @DateTime.Now.ToShortDateString() <br />
            <b>Hora: </b> @DateTime.Now.ToShortTimeString() <br />
        </div>
    </div>
    <div>
        <div class="col-lg-12 no-padder">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-center">Factura</th>
                        <th class="text-center">Fecha</th>
                        <th class="text-center">Estado</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Descuento</th>
                        <th class="text-right">Cantidad Total</th>
                        <th class="text-right">Cantidad Pagado</th>
                        <th class="text-right">Cantidad Restante</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal totalInvoice = 0.0m;
                        decimal totalDiscount = 0.0m;
                        decimal totalGeneral = 0.0m;
                        decimal totalRest = 0.0m;
                        decimal totalPayment = 0.0m;

                        var invoiceByRaffle = Model.AsEnumerable().GroupBy(r => r.IdRaffle).Select(i => new
                        {
                            raffleName = i.FirstOrDefault().IdRaffle + " - " + i.FirstOrDefault().NameRaffle,
                            invoiceByClients = i.GroupBy(c => c.IdClient).Select(c => new
                            {
                                clientName = c.FirstOrDefault().IdClient + " - " + c.FirstOrDefault().NameClient,
                                clientType = c.FirstOrDefault().TypeClient,
                                invoiceId = c.FirstOrDefault().IdInvoice,
                                invoiceDate = c.FirstOrDefault().DateInvoice.ToString("dd/MM/yyyy"),
                                invoiceStatus = c.FirstOrDefault().StatusInvoice,
                                invoiceTotal = c.FirstOrDefault().TotalInvoice,
                                invoiceDiscount = c.FirstOrDefault().TotalDiscount,
                                totalToPay = c.FirstOrDefault().TotalToPay,
                                totalCash = c.FirstOrDefault().CashPayment,
                                totalNoteCredit = c.FirstOrDefault().NoteCreditPayment,
                                totalPending = c.FirstOrDefault().TotalPending,
                                reportType = c.FirstOrDefault().ReportType
                            })
                        }).ToList();

                    }
                    @foreach (var raffle in invoiceByRaffle)
                    {
                        decimal totalInvoicer = 0.0m;
                        decimal totalDiscountr = 0.0m;
                        decimal totalGeneralr = 0.0m;
                        decimal totalRestr = 0.0m;
                        decimal totalPaymentr = 0.0m;

                        if (raffle.invoiceByClients.Any(a => a.reportType == (int)Tickets.Models.Enums.ReceivableTypeEnum.Payed))
                        {
                            foreach (var client in raffle.invoiceByClients.Where(w => w.totalPending == 0))
                            {
                                decimal totalInvoicec = 0.0m;
                                decimal totalDiscountc = 0.0m;
                                decimal totalGeneralc = 0.0m;
                                decimal totalRestc = 0.0m;
                                decimal totalPaymentc = 0.0m;
                                <tr>
                                    <th colspan="8" class="text-center">@raffle.raffleName</th>
                                </tr>
                                <tr>
                                    @*<th colspan="2" class="text-left"></th>*@
                                    <th colspan="8" class="text-center">@client.clientName - @client.clientType</th>
                                </tr>
                                <tr>
                                    <td class="text-center">@client.invoiceId</td>
                                    <td class="text-center">@client.invoiceDate</td>
                                    <td class="text-center">@client.invoiceStatus</td>
                                    <td class="text-right">@client.invoiceTotal.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.invoiceDiscount.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.totalToPay.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@((client.totalCash + client.totalNoteCredit).ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@client.totalPending.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                </tr>
                                totalInvoicec += client.invoiceTotal;
                                totalDiscountc += client.invoiceDiscount;
                                totalGeneralc += client.totalToPay;
                                totalRestc += client.totalPending;
                                totalPaymentc += (client.totalCash + client.totalNoteCredit);
                                <tr class="sub-total" style="font-weight:bold">
                                    <td class="text-right" colspan="3">Total Cliente: </td>
                                    <td class="text-right">@(totalInvoicec.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalDiscountc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalGeneralc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalPaymentc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalRestc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                </tr>
                                totalInvoicer += totalInvoicec;
                                totalDiscountr += totalDiscountc;
                                totalGeneralr += totalGeneralc;
                                totalRestr += totalRestc;
                                totalPaymentr += totalPaymentc;
                            }
                            if (raffle.invoiceByClients.Any(a => a.totalPending == 0))
                            {
                                <tr class="sub-total" style="font-weight:bold">
                                    <td class="text-right" colspan="3">Total Sorteo: </td>
                                    <td class="text-right">@(totalInvoicer.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalDiscountr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalGeneralr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalPaymentr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalRestr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                </tr>
                                totalInvoice += totalInvoicer;
                                totalDiscount += totalDiscountr;
                                totalGeneral += totalGeneralr;
                                totalRest += totalRestr;
                                totalPayment += totalPaymentr;
                            }
                        }
                        else if (raffle.invoiceByClients.Any(a => a.reportType == (int)Tickets.Models.Enums.ReceivableTypeEnum.Pending))
                        {
                            foreach (var client in raffle.invoiceByClients.Where(w => w.totalPending > 0))
                            {
                                decimal totalInvoicec = 0.0m;
                                decimal totalDiscountc = 0.0m;
                                decimal totalGeneralc = 0.0m;
                                decimal totalRestc = 0.0m;
                                decimal totalPaymentc = 0.0m;
                                <tr>
                                    <th colspan="8" class="text-center">@raffle.raffleName</th>
                                </tr>
                                <tr>
                                    @*<th colspan="2" class="text-left"></th>*@
                                    <th colspan="8" class="text-center">@client.clientName - @client.clientType</th>
                                </tr>
                                <tr>
                                    <td class="text-center">@client.invoiceId</td>
                                    <td class="text-center">@client.invoiceDate</td>
                                    <td class="text-center">@client.invoiceStatus</td>
                                    <td class="text-right">@client.invoiceTotal.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.invoiceDiscount.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.totalToPay.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@((client.totalCash + client.totalNoteCredit).ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@client.totalPending.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                </tr>
                                totalInvoicec += client.invoiceTotal;
                                totalDiscountc += client.invoiceDiscount;
                                totalGeneralc += client.totalToPay;
                                totalRestc += client.totalPending;
                                totalPaymentc += (client.totalCash + client.totalNoteCredit);
                                <tr class="sub-total" style="font-weight:bold">
                                    <td class="text-right" colspan="3">Total Cliente: </td>
                                    <td class="text-right">@(totalInvoicec.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalDiscountc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalGeneralc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalPaymentc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalRestc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                </tr>
                                totalInvoicer += totalInvoicec;
                                totalDiscountr += totalDiscountc;
                                totalGeneralr += totalGeneralc;
                                totalRestr += totalRestc;
                                totalPaymentr += totalPaymentc;
                            }
                            if (raffle.invoiceByClients.Any(a => a.totalPending > 0))
                            {
                                <tr class="sub-total" style="font-weight:bold">
                                    <td class="text-right" colspan="3">Total Sorteo: </td>
                                    <td class="text-right">@(totalInvoicer.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalDiscountr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalGeneralr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalPaymentr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalRestr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                </tr>
                                totalInvoice += totalInvoicer;
                                totalDiscount += totalDiscountr;
                                totalGeneral += totalGeneralr;
                                totalRest += totalRestr;
                                totalPayment += totalPaymentr;
                            }
                        }
                        else
                        {
                            foreach (var client in raffle.invoiceByClients)
                            {
                                decimal totalInvoicec = 0.0m;
                                decimal totalDiscountc = 0.0m;
                                decimal totalGeneralc = 0.0m;
                                decimal totalRestc = 0.0m;
                                decimal totalPaymentc = 0.0m;
                                <tr>
                                    <th colspan="8" class="text-center">@raffle.raffleName</th>
                                </tr>
                                <tr>
                                    @*<th colspan="2" class="text-left"></th>*@
                                    <th colspan="8" class="text-center">@client.clientName - @client.clientType</th>
                                </tr>
                                <tr>
                                    <td class="text-center">@client.invoiceId</td>
                                    <td class="text-center">@client.invoiceDate</td>
                                    <td class="text-center">@client.invoiceStatus</td>
                                    <td class="text-right">@client.invoiceTotal.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.invoiceDiscount.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@client.totalToPay.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                    <td class="text-right">@((client.totalCash + client.totalNoteCredit).ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@client.totalPending.ToString("c", new System.Globalization.CultureInfo("es-DO"))</td>
                                </tr>
                                totalInvoicec += client.invoiceTotal;
                                totalDiscountc += client.invoiceDiscount;
                                totalGeneralc += client.totalToPay;
                                totalRestc += client.totalPending;
                                totalPaymentc += (client.totalCash + client.totalNoteCredit);
                                <tr class="sub-total" style="font-weight:bold">
                                    <td class="text-right" colspan="3">Total Cliente: </td>
                                    <td class="text-right">@(totalInvoicec.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalDiscountc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalGeneralc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalPaymentc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                    <td class="text-right">@(totalRestc.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                </tr>
                                totalInvoicer += totalInvoicec;
                                totalDiscountr += totalDiscountc;
                                totalGeneralr += totalGeneralc;
                                totalRestr += totalRestc;
                                totalPaymentr += totalPaymentc;
                            }
                            <tr class="sub-total" style="font-weight:bold">
                                <td class="text-right" colspan="3">Total Sorteo: </td>
                                <td class="text-right">@(totalInvoicer.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                <td class="text-right">@(totalDiscountr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                <td class="text-right">@(totalGeneralr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                <td class="text-right">@(totalPaymentr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                                <td class="text-right">@(totalRestr.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                            </tr>
                            totalInvoice += totalInvoicer;
                            totalDiscount += totalDiscountr;
                            totalGeneral += totalGeneralr;
                            totalRest += totalRestr;
                            totalPayment += totalPaymentr;
                        }
                    }
                </tbody>
                <tfoot>
                    <tr class="total" style="font-weight:bold">
                        <td class="text-right" colspan="3">Total General:..</td>
                        <td class="text-right">@(totalInvoice.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                        <td class="text-right">@(totalDiscount.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                        <td class="text-right">@(totalGeneral.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                        <td class="text-right">@(totalPayment.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                        <td class="text-right">@(totalRest.ToString("c",  new System.Globalization.CultureInfo("es-DO")))</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="col-lg-12 no-padder text-center">
        <br />
        <br />
        <br />
        <br />
        <div class="col-lg-4 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Encargada división de créditos y cobros
        </div>
        <div class="col-lg-4 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">

            </div>
        </div>
        <div class="col-lg-4 col-md-6 col-sm-6 text-center">
            <div class="col-lg-12 no-padder text-center">
                ______________________________
            </div>
            Directora financiera
        </div>
    </div>

    @*<div class="col-lg-12 col-md-12 col-sm-12 no-padder text-center">
            <b>@adminName</b><br />
            <span>@adminCargo</span>
        </div>*@
</div>
